# Generating and using tokens

Tokens in the CLP API are generated by the Identity Server.

There's a separate client, `IdentityServerClient`, that is responsible for generating these tokens. The Identity Server Client is also capable of automatically regenerating a token once it expires, via the `provideAccessMethod()` token.

In order to inject the token on the API calls, the CLP API exposes a neutral provider-oriented callback system. Through this system, you can make a call to the Identity Server client and provide a valid token for the call.

### Example

```
<?php
require("vendor/autoload.php");

// Create the Config repository via .env file.
$config = new DotEnvConfigLoader(Dotenv::create(__DIR__));

// Creates the identity server client.
$identityServer = new IdentityServerClient($config);

// Creates the CLP client.
$client = new CLPClient($config);

// This will register a closure as the provider for Authorization headers.
// This difers from passing a token directly as a header on each API call, as
// this will be called on every request, and will override any Authorization headers
// given in the request config. 
$client->setAuthorizationHeaderProvider(function () use ($identityServer) {

    // The function provideAccessToken() will check if a previously-generated token exists and is still valid, and return that.
    // Otherwise, it will generate a new one, save that and return it.
    // The returned object is an AccessToken struct, and contains some helpers to check validity & expiry date.
    $accessToken = $identityServer->provideAccessToken();
    
    // Returns the Access Token, in Authorization header format ("Authorization: Bearer <token>").
    return $accessToken->generateAuthorizationHeader();
    
});

// All calls done from here on are correctly authenticated.

```

### Laravel Applications
Applications using Laravel do not need to concern with generating access tokens manually, as this is done automatically on the service provider. Just inject your dependencies and start making calls.